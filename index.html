<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            color: #2196F3;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .setup-box {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-box h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .setup-box p {
            color: #155724;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .notification-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .log-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .emoji {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .timer-display .time {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
        }

        .device-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }

        .step-list {
            text-align: left;
            margin: 15px 0;
            padding-left: 20px;
        }

        .step-list li {
            margin-bottom: 8px;
            color: #155724;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="emoji">üîî</span>
        <h1>Push Notification System</h1>
        <p class="subtitle">Notifikasi akan muncul setiap 2 jam sekali</p>

        <div class="setup-box" id="setupBox" style="display: none;">
            <h3>üì• Setup untuk Mobile (Sekali Saja)</h3>
            <p>Untuk HP Android/iOS, butuh file Service Worker</p>
            <button class="btn-success" onclick="downloadServiceWorker()">
                Download sw.js (Simpan di Folder yang Sama)
            </button>
            <ol class="step-list">
                <li>Klik tombol di atas, download <code>sw.js</code></li>
                <li>Upload <code>sw.js</code> ke folder yang sama dengan HTML ini</li>
                <li>Refresh halaman ini</li>
            </ol>
        </div>

        <div class="device-info" id="deviceInfo">
            <strong>üì± Device:</strong> <span id="deviceType">Detecting...</span><br>
            <strong>üîß Method:</strong> <span id="notificationMethod">Detecting...</span>
        </div>

        <div class="warning-box" id="warningBox" style="display: none;">
            <strong>‚ö†Ô∏è Penting:</strong>
            <span id="warningText"></span>
        </div>

        <div class="timer-display" id="timerDisplay" style="display: none;">
            <div>‚è∞ Notifikasi Berikutnya:</div>
            <div class="time" id="countdown">--:--:--</div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-label">Status Notifikasi:</span>
                <span class="status-badge badge-danger" id="notifStatus">Belum Diaktifkan</span>
            </div>
            <div class="status-item">
                <span class="status-label">System Status:</span>
                <span class="status-badge badge-warning" id="systemStatus">Initializing...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Notifikasi Terkirim:</span>
                <span class="status-value" id="notifCount">0</span>
            </div>
        </div>

        <button class="btn-primary" id="enableBtn" onclick="enableNotifications()" disabled>
            Aktifkan Notifikasi
        </button>
        <button class="btn-secondary" id="testBtn" onclick="sendTestNotification()" disabled>
            Test Notifikasi Sekarang
        </button>
        <button class="btn-danger" id="disableBtn" onclick="disableNotifications()" disabled>
            Nonaktifkan Notifikasi
        </button>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Cara Kerja:</strong>
            1. Klik "Aktifkan Notifikasi" dan izinkan akses<br>
            2. Notifikasi akan muncul setiap 2 jam sekali<br>
            3. <strong id="keepAliveInfo">Sistem akan tetap berjalan</strong><br>
            4. Bekerja di semua device (Mobile & Desktop)
        </div>

        <div class="notification-log">
            <div class="log-title">üìã Log Notifikasi:</div>
            <div id="logContainer">
                <div class="log-item">Menunggu aktivasi...</div>
            </div>
        </div>
    </div>

    <script>
        let notificationCount = 0;
        let notificationTimer = null;
        let countdownTimer = null;
        let nextNotificationTime = null;
        let isEnabled = false;
        let serviceWorkerRegistration = null;
        let usesServiceWorker = false;

        const NOTIFICATION_INTERVAL = 2 * 60 * 60 * 1000; // 2 jam
        // const NOTIFICATION_INTERVAL = 10 * 1000; // 10 detik untuk testing

        // Service Worker code untuk di-download
        const SW_CODE = `// Service Worker untuk Push Notification
const INTERVAL = 2 * 60 * 60 * 1000; // 2 jam
let intervalId = null;

self.addEventListener('install', (event) => {
    console.log('[SW] Installing...');
    self.skipWaiting();
});

self.addEventListener('activate', (event) => {
    console.log('[SW] Activated');
    event.waitUntil(clients.claim());
});

async function showNotification(isTest = false) {
    const title = isTest ? 'üß™ Test Notifikasi' : 'üîî Notifikasi Terjadwal';
    const body = isTest ? 'Test notifikasi berhasil!' : 'Notifikasi otomatis setiap 2 jam. Tetap produktif! üí™';
    
    const options = {
        body: body,
        icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        vibrate: [200, 100, 200, 100, 200],
        tag: isTest ? 'test-notification' : 'scheduled-notification',
        requireInteraction: false,
        data: {
            url: self.location.origin,
            time: Date.now()
        }
    };

    try {
        await self.registration.showNotification(title, options);
        
        // Broadcast ke clients
        const allClients = await clients.matchAll();
        allClients.forEach(client => {
            client.postMessage({
                type: 'notification-sent',
                isTest: isTest,
                timestamp: Date.now()
            });
        });
        
        console.log('[SW] Notification sent:', new Date().toLocaleString());
    } catch (error) {
        console.error('[SW] Error showing notification:', error);
    }
}

function startSchedule() {
    if (intervalId) clearInterval(intervalId);
    
    // Kirim notifikasi pertama
    showNotification(false);
    
    // Schedule notifikasi berikutnya
    intervalId = setInterval(() => {
        showNotification(false);
    }, INTERVAL);
    
    console.log('[SW] Schedule started');
}

function stopSchedule() {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
    
    // Close semua notifikasi yang ada
    self.registration.getNotifications().then(notifications => {
        notifications.forEach(notification => notification.close());
    });
    
    console.log('[SW] Schedule stopped');
}

self.addEventListener('message', (event) => {
    console.log('[SW] Message received:', event.data.type);
    
    if (event.data.type === 'start') {
        startSchedule();
    } else if (event.data.type === 'test') {
        showNotification(true);
    } else if (event.data.type === 'stop') {
        stopSchedule();
    }
});

self.addEventListener('notificationclick', (event) => {
    event.notification.close();
    
    event.waitUntil(
        clients.matchAll({ type: 'window' }).then((clientList) => {
            for (let client of clientList) {
                if ('focus' in client) {
                    return client.focus();
                }
            }
            if (clients.openWindow) {
                return clients.openWindow('/');
            }
        })
    );
});

self.addEventListener('notificationclose', (event) => {
    console.log('[SW] Notification closed');
});
`;

        // Download Service Worker file
        function downloadServiceWorker() {
            const blob = new Blob([SW_CODE], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sw.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('‚úÖ File sw.js berhasil didownload!');
            addLog('üì§ Silakan upload sw.js ke folder yang sama dengan HTML ini');
            addLog('üîÑ Setelah upload, refresh halaman ini');
        }

        // Detect device type
        function detectDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            
            let deviceType = 'Desktop';
            if (isAndroid) deviceType = 'Android';
            else if (isIOS) deviceType = 'iOS';
            else if (isMobile) deviceType = 'Mobile';
            
            document.getElementById('deviceType').textContent = deviceType;
            return { isMobile, isAndroid, isIOS, deviceType };
        }

        // Register Service Worker dari file
        async function registerServiceWorker() {
            try {
                // Unregister existing
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let reg of regs) {
                    await reg.unregister();
                }

                // Register dari file sw.js
                serviceWorkerRegistration = await navigator.serviceWorker.register('./sw.js', {
                    scope: './'
                });
                
                await navigator.serviceWorker.ready;
                
                // Listen for messages
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'notification-sent') {
                        if (!event.data.isTest) {
                            incrementNotificationCount();
                        }
                        const msg = event.data.isTest ? 'Test notifikasi' : `Notifikasi #${notificationCount}`;
                        addLog(`üì® ${msg} terkirim`);
                    }
                });

                addLog('‚úÖ Service Worker terdaftar dari sw.js');
                return true;
            } catch (error) {
                console.error('SW Registration Error:', error);
                throw error;
            }
        }

        // Initialize system
        async function initializeSystem() {
            const device = detectDevice();
            
            if (!('Notification' in window)) {
                document.getElementById('systemStatus').textContent = 'Not Supported';
                document.getElementById('systemStatus').className = 'status-badge badge-danger';
                showWarning('Browser tidak mendukung notifikasi');
                return false;
            }

            const needsServiceWorker = device.isMobile || device.isAndroid || device.isIOS;

            if (needsServiceWorker) {
                // Mobile - WAJIB Service Worker
                if ('serviceWorker' in navigator) {
                    try {
                        await registerServiceWorker();
                        usesServiceWorker = true;
                        document.getElementById('notificationMethod').textContent = 'Service Worker';
                        document.getElementById('keepAliveInfo').textContent = 'Notifikasi berjalan walau tab ditutup';
                        document.getElementById('systemStatus').textContent = 'Ready';
                        document.getElementById('systemStatus').className = 'status-badge badge-success';
                        document.getElementById('enableBtn').disabled = false;
                        addLog('‚úÖ Service Worker siap (Mobile Mode)');
                    } catch (error) {
                        // File sw.js tidak ditemukan
                        if (error.message.includes('404') || error.message.includes('not found')) {
                            document.getElementById('setupBox').style.display = 'block';
                            document.getElementById('systemStatus').textContent = 'Setup Required';
                            document.getElementById('systemStatus').className = 'status-badge badge-warning';
                            showWarning('File sw.js tidak ditemukan. Download dan upload ke hosting Anda.');
                            addLog('‚ö†Ô∏è File sw.js tidak ditemukan');
                            addLog('üì• Klik tombol "Download sw.js" di atas');
                        } else {
                            document.getElementById('systemStatus').textContent = 'Error';
                            document.getElementById('systemStatus').className = 'status-badge badge-danger';
                            showWarning('Error: ' + error.message);
                            addLog('‚ùå Error: ' + error.message);
                        }
                        return false;
                    }
                } else {
                    document.getElementById('systemStatus').textContent = 'Not Supported';
                    document.getElementById('systemStatus').className = 'status-badge badge-danger';
                    showWarning('Browser tidak mendukung Service Worker');
                    return false;
                }
            } else {
                // Desktop - Direct API
                usesServiceWorker = false;
                document.getElementById('notificationMethod').textContent = 'Direct API (Desktop)';
                document.getElementById('keepAliveInfo').textContent = 'Tab harus tetap terbuka di background';
                document.getElementById('systemStatus').textContent = 'Ready';
                document.getElementById('systemStatus').className = 'status-badge badge-success';
                document.getElementById('enableBtn').disabled = false;
                addLog('‚úÖ Direct Notification API (Desktop Mode)');
            }

            loadSavedState();
            return true;
        }

        // Send notification
        async function sendNotification(isTest = false) {
            if (Notification.permission !== 'granted') {
                addLog('‚ùå Permission belum diberikan');
                return;
            }

            try {
                if (usesServiceWorker && serviceWorkerRegistration) {
                    // Service Worker method
                    const sw = await navigator.serviceWorker.ready;
                    sw.active.postMessage({ type: isTest ? 'test' : 'start' });
                } else {
                    // Direct API method (Desktop)
                    const title = isTest ? 'üß™ Test Notifikasi' : 'üîî Notifikasi Terjadwal';
                    const body = isTest ? 'Test berhasil!' : 'Notifikasi otomatis setiap 2 jam';
                    
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
                        vibrate: [200, 100, 200],
                        tag: isTest ? 'test' : 'scheduled'
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    setTimeout(() => notification.close(), 10000);

                    if (!isTest) {
                        incrementNotificationCount();
                    }
                    addLog(`üì® ${isTest ? 'Test' : 'Notifikasi #' + notificationCount} terkirim`);
                }
            } catch (error) {
                addLog('‚ùå Error: ' + error.message);
                console.error('Notification error:', error);
            }
        }

        // Schedule next notification
        function scheduleNextNotification(delay = NOTIFICATION_INTERVAL) {
            if (notificationTimer) clearTimeout(notificationTimer);

            nextNotificationTime = Date.now() + delay;
            localStorage.setItem('nextNotificationTime', nextNotificationTime);

            notificationTimer = setTimeout(() => {
                sendNotification(false);
                scheduleNextNotification();
            }, delay);

            startCountdown();
            addLog(`‚è∞ Berikutnya: ${new Date(nextNotificationTime).toLocaleTimeString('id-ID')}`);
        }

        // Countdown timer
        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            document.getElementById('timerDisplay').style.display = 'block';

            countdownTimer = setInterval(() => {
                if (!nextNotificationTime) return;

                const remaining = nextNotificationTime - Date.now();
                if (remaining <= 0) {
                    document.getElementById('countdown').textContent = '00:00:00';
                    return;
                }

                const h = Math.floor(remaining / 3600000);
                const m = Math.floor((remaining % 3600000) / 60000);
                const s = Math.floor((remaining % 60000) / 1000);

                document.getElementById('countdown').textContent = 
                    `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Enable notifications
        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    startNotifications();
                } else {
                    showWarning('Permission ditolak');
                    addLog('‚ùå Permission tidak diberikan');
                }
            } catch (error) {
                showWarning('Error: ' + error.message);
                addLog('‚ùå Error: ' + error.message);
            }
        }

        function startNotifications() {
            isEnabled = true;
            localStorage.setItem('notificationEnabled', 'true');
            updateUIState(true);
            
            sendNotification(false);
            
            if (!usesServiceWorker) {
                scheduleNextNotification();
            }
            
            addLog('‚úÖ Notifikasi diaktifkan');
            addLog('üìÖ Notifikasi akan muncul setiap 2 jam');
        }

        function sendTestNotification() {
            sendNotification(true);
        }

        function disableNotifications() {
            if (usesServiceWorker && serviceWorkerRegistration) {
                navigator.serviceWorker.ready.then(sw => {
                    sw.active.postMessage({ type: 'stop' });
                });
            }

            if (notificationTimer) clearTimeout(notificationTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            isEnabled = false;
            nextNotificationTime = null;
            localStorage.setItem('notificationEnabled', 'false');
            localStorage.removeItem('nextNotificationTime');
            
            document.getElementById('timerDisplay').style.display = 'none';
            updateUIState(false);
            addLog('üî¥ Notifikasi dinonaktifkan');
        }

        function updateUIState(enabled) {
            document.getElementById('enableBtn').disabled = enabled;
            document.getElementById('testBtn').disabled = !enabled;
            document.getElementById('disableBtn').disabled = !enabled;
            
            const badge = document.getElementById('notifStatus');
            badge.textContent = enabled ? 'Aktif' : 'Nonaktif';
            badge.className = `status-badge badge-${enabled ? 'success' : 'danger'}`;
        }

        function incrementNotificationCount() {
            notificationCount++;
            localStorage.setItem('notificationCount', notificationCount);
            document.getElementById('notifCount').textContent = notificationCount;
        }

        function loadSavedState() {
            const count = localStorage.getItem('notificationCount');
            if (count) {
                notificationCount = parseInt(count);
                document.getElementById('notifCount').textContent = notificationCount;
            }

            const enabled = localStorage.getItem('notificationEnabled');
            if (enabled === 'true' && Notification.permission === 'granted') {
                isEnabled = true;
                updateUIState(true);
                
                if (!usesServiceWorker) {
                    const nextTime = localStorage.getItem('nextNotificationTime');
                    if (nextTime) {
                        nextNotificationTime = parseInt(nextTime);
                        const remaining = nextNotificationTime - Date.now();
                        if (remaining > 0) {
                            scheduleNextNotification(remaining);
                            addLog('‚úÖ Sesi dilanjutkan');
                        } else {
                            startNotifications();
                        }
                    }
                } else {
                    navigator.serviceWorker.ready.then(sw => {
                        sw.active.postMessage({ type: 'start' });
                        addLog('‚úÖ Service Worker dilanjutkan');
                    });
                }
            }
        }

        function showWarning(text) {
            document.getElementById('warningText').textContent = text;
            document.getElementById('warningBox').style.display = 'block';
        }

        function addLog(msg) {
            const container = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = 'log-item';
            const time = new Date().toLocaleTimeString('id-ID');
            item.textContent = `[${time}] ${msg}`;
            
            if (container.firstChild?.textContent === 'Menunggu aktivasi...') {
                container.innerHTML = '';
            }
            
            container.insertBefore(item, container.firstChild);
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeSystem();
        });
    </script>
</body>
</html>
