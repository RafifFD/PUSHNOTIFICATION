<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Push Notification System - Notifikasi otomatis setiap 2 jam">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notif System">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/3602/3602145.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3602/3602145.png">
    <title>Push Notification PWA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .pwa-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .install-prompt h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .install-prompt p {
            font-size: 13px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-install {
            background: white;
            color: #667eea;
            border: 2px solid white;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            color: #2196F3;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .notification-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .log-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .emoji {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .timer-display .time {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
        }

        .setup-box {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-box h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .setup-instructions {
            text-align: left;
            margin: 15px 0;
            padding-left: 20px;
        }

        .setup-instructions li {
            margin-bottom: 8px;
            color: #155724;
            font-size: 13px;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #c82333;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="pwa-badge">‚ö° PWA Mode</span>
        
        <div class="install-prompt" id="installPrompt" style="display: none;">
            <h3>üì± Install Aplikasi</h3>
            <p>Install ke home screen untuk notifikasi 24/7</p>
            <button class="btn-install" onclick="installPWA()">
                ‚¨áÔ∏è Install Sekarang
            </button>
        </div>

        <span class="emoji">üîî</span>
        <h1>Push Notification PWA</h1>
        <p class="subtitle">Notifikasi setiap 30 detik (Mode Testing ‚ö°)</p>

        <div class="setup-box" id="setupBox" style="display: none;">
            <h3>üì• Setup File Diperlukan</h3>
            <button class="btn-success" onclick="downloadAllFiles()" style="margin: 10px 0;">
                üì¶ Download Semua File (3 files)
            </button>
            <ol class="setup-instructions">
                <li>Download <code>manifest.json</code>, <code>sw.js</code>, dan <code>icon.png</code></li>
                <li>Upload ke folder yang sama dengan HTML ini</li>
                <li>Refresh halaman</li>
            </ol>
        </div>

        <div class="warning-box" id="warningBox" style="display: none;">
            <strong>‚ö†Ô∏è Penting:</strong>
            <span id="warningText"></span>
        </div>

        <div class="timer-display" id="timerDisplay" style="display: none;">
            <div>‚è∞ Notifikasi Berikutnya:</div>
            <div class="time" id="countdown">--:--:--</div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-label">PWA Status:</span>
                <span class="status-badge badge-warning" id="pwaStatus">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Notifikasi:</span>
                <span class="status-badge badge-danger" id="notifStatus">Nonaktif</span>
            </div>
            <div class="status-item">
                <span class="status-label">Terkirim:</span>
                <span class="status-value" id="notifCount">0</span>
            </div>
        </div>

        <button class="btn-primary" id="enableBtn" onclick="enableNotifications()" disabled>
            Aktifkan Notifikasi
        </button>
        <button class="btn-secondary" id="testBtn" onclick="sendTestNotification()" disabled>
            Test Notifikasi
        </button>
        <button class="btn-secondary" onclick="debugServiceWorker()" style="background: #6610f2; color: white;">
            üêõ Debug Service Worker
        </button>
        <button class="btn-secondary" onclick="checkNotificationSettings()" style="background: #ffc107; color: #333;">
            üîç Cek Pengaturan Notifikasi
        </button>
        <button class="btn-secondary" onclick="forceUpdateSW()" style="background: #17a2b8;">
            üîÑ Force Update Service Worker
        </button>
        <button class="btn-danger" id="disableBtn" onclick="disableNotifications()" disabled>
            Nonaktifkan
        </button>

        <div class="info-box">
            <strong>‚ÑπÔ∏è PWA Features:</strong>
            ‚úÖ Notifikasi 24/7 walau app ditutup<br>
            ‚úÖ Install ke home screen<br>
            ‚úÖ Bekerja offline<br>
            ‚úÖ Auto-update schedule<br>
            ‚úÖ Battery efficient
        </div>

        <div class="notification-log">
            <div class="log-title">üìã Activity Log:</div>
            <div id="logContainer">
                <div class="log-item">Initializing PWA...</div>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let swRegistration = null;
        let notificationCount = 0;
        let isEnabled = false;
        let countdownTimer = null;

        // ‚è∞ UBAH INTERVAL DISINI:
        // const NOTIFICATION_INTERVAL = 2 * 60 * 60 * 1000; // 2 jam (production)
        const NOTIFICATION_INTERVAL = 30 * 1000; // 30 detik (testing) ‚ö°

        // Manifest JSON
        const MANIFEST = {
            name: "Push Notification System",
            short_name: "Notif PWA",
            description: "Push notification system yang bekerja 24/7",
            start_url: "./",
            display: "standalone",
            background_color: "#667eea",
            theme_color: "#667eea",
            orientation: "portrait",
            icons: [
                {
                    src: "https://cdn-icons-png.flaticon.com/512/3602/3602145.png",
                    sizes: "192x192",
                    type: "image/png",
                    purpose: "any maskable"
                },
                {
                    src: "https://cdn-icons-png.flaticon.com/512/3602/3602145.png",
                    sizes: "512x512",
                    type: "image/png",
                    purpose: "any maskable"
                }
            ]
        };

        // Service Worker Code
        const SW_CODE = `
// ‚è∞ UBAH INTERVAL DISINI JUGA (harus sama dengan yang di HTML):
// const NOTIFICATION_INTERVAL = 2 * 60 * 60 * 1000; // 2 jam (production)
const NOTIFICATION_INTERVAL = 30 * 1000; // 30 detik (testing) ‚ö°
const CACHE_NAME = 'notif-pwa-v2'; // Increment version untuk force update
let intervalId = null;
let nextNotificationTime = null;

self.addEventListener('install', (event) => {
    console.log('[SW] Installing... Version with 30 second interval');
    self.skipWaiting(); // Force activate immediately
});

self.addEventListener('activate', (event) => {
    console.log('[SW] Activated - 30 second interval active');
    event.waitUntil(
        clients.claim().then(() => {
            console.log('[SW] All clients claimed');
        })
    );
});

async function showNotification(isTest = false) {
    const title = isTest ? 'üß™ Test Notifikasi' : 'üîî Notifikasi Terjadwal';
    const body = isTest 
        ? 'Test notifikasi PWA berhasil!' 
        : 'Reminder otomatis setiap 30 detik (testing mode)';
    
    const options = {
        body: body,
        icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        vibrate: [200, 100, 200, 100, 200],
        tag: isTest ? 'test-notification' : 'scheduled-notification',
        requireInteraction: false,
        data: {
            url: self.location.origin,
            time: Date.now()
        },
        actions: [
            { action: 'open', title: 'Buka App' },
            { action: 'close', title: 'Tutup' }
        ]
    };

    try {
        await self.registration.showNotification(title, options);
        
        const allClients = await clients.matchAll({ includeUncontrolled: true });
        allClients.forEach(client => {
            client.postMessage({
                type: 'notification-sent',
                isTest: isTest,
                timestamp: Date.now()
            });
        });
        
        console.log('[SW] Notification sent:', new Date().toLocaleString());
    } catch (error) {
        console.error('[SW] Notification error:', error);
    }
}

function startSchedule() {
    console.log('[SW] Starting notification schedule with 30 SECOND interval...');
    
    // Clear interval lama
    if (intervalId) {
        clearInterval(intervalId);
        console.log('[SW] Cleared previous interval');
    }
    
    // Simpan waktu mulai
    const startTime = Date.now();
    console.log('[SW] Start time:', new Date(startTime).toLocaleString());
    
    // Kirim notifikasi pertama LANGSUNG
    console.log('[SW] Sending FIRST notification NOW');
    showNotification(false);
    nextNotificationTime = Date.now() + NOTIFICATION_INTERVAL;
    
    // Gunakan recursive setTimeout untuk lebih reliable
    function scheduleNext() {
        const now = Date.now();
        const elapsed = now - startTime;
        const expectedTriggers = Math.floor(elapsed / NOTIFICATION_INTERVAL);
        
        console.log('[SW] Scheduling next notification...');
        console.log('[SW] Time elapsed:', Math.floor(elapsed / 1000), 'seconds');
        
        setTimeout(() => {
            console.log('[SW] ‚è∞ TIMER TRIGGERED! Sending notification...');
            showNotification(false);
            nextNotificationTime = Date.now() + NOTIFICATION_INTERVAL;
            
            // Schedule berikutnya
            scheduleNext();
        }, NOTIFICATION_INTERVAL);
    }
    
    // Mulai recursive schedule
    scheduleNext();
    
    // Backup: setInterval sebagai fallback
    intervalId = setInterval(() => {
        console.log('[SW] üîÑ INTERVAL BACKUP triggered - sending notification');
        showNotification(false);
        nextNotificationTime = Date.now() + NOTIFICATION_INTERVAL;
    }, NOTIFICATION_INTERVAL);
    
    console.log('[SW] ‚úÖ Schedule started successfully!');
    console.log('[SW] Next notification in 30 seconds');
    console.log('[SW] Interval ID:', intervalId);
    
    // Broadcast status ke clients
    clients.matchAll().then(allClients => {
        allClients.forEach(client => {
            client.postMessage({
                type: 'schedule-started',
                interval: NOTIFICATION_INTERVAL,
                nextTime: nextNotificationTime
            });
        });
    });
}

function stopSchedule() {
    console.log('[SW] Stopping schedule...');
    
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
    
    nextNotificationTime = null;
    
    self.registration.getNotifications().then(notifications => {
        notifications.forEach(notification => notification.close());
    });
}

self.addEventListener('message', (event) => {
    console.log('[SW] Message received:', event.data);
    
    if (event.data.type === 'start') {
        startSchedule();
    } else if (event.data.type === 'stop') {
        stopSchedule();
    } else if (event.data.type === 'test') {
        showNotification(true);
    } else if (event.data.type === 'get-status') {
        event.ports[0].postMessage({
            isRunning: intervalId !== null,
            nextNotificationTime: nextNotificationTime
        });
    }
});

self.addEventListener('notificationclick', (event) => {
    event.notification.close();
    
    if (event.action === 'close') {
        return;
    }
    
    event.waitUntil(
        clients.matchAll({ type: 'window', includeUncontrolled: true })
            .then((clientList) => {
                for (let client of clientList) {
                    if ('focus' in client) {
                        return client.focus();
                    }
                }
                if (clients.openWindow) {
                    return clients.openWindow('/');
                }
            })
    );
});

self.addEventListener('notificationclose', (event) => {
    console.log('[SW] Notification closed');
});

// Keep alive - periodic sync
self.addEventListener('sync', (event) => {
    console.log('[SW] Background sync triggered');
    if (event.tag === 'notification-sync') {
        event.waitUntil(showNotification(false));
    }
});
`;

        // Initialize PWA
        async function initializePWA() {
            addLog('üöÄ Initializing PWA...');

            // Check if standalone (installed)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                              || window.navigator.standalone 
                              || document.referrer.includes('android-app://');
            
            if (isStandalone) {
                document.getElementById('pwaStatus').textContent = 'Installed';
                document.getElementById('pwaStatus').className = 'status-badge badge-success';
                addLog('‚úÖ PWA sudah terinstall');
            } else {
                document.getElementById('pwaStatus').textContent = 'Browser Mode';
                document.getElementById('pwaStatus').className = 'status-badge badge-info';
                addLog('üì± Belum diinstall (bisa tetap digunakan)');
            }

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    // Force unregister old SW first
                    const oldRegs = await navigator.serviceWorker.getRegistrations();
                    for (let reg of oldRegs) {
                        await reg.unregister();
                    }
                    
                    swRegistration = await navigator.serviceWorker.register('./sw.js', {
                        updateViaCache: 'none' // Force fresh download
                    });
                    
                    // Wait for SW to be ready
                    await navigator.serviceWorker.ready;
                    
                    addLog('‚úÖ Service Worker ready (30 second interval)');
                    document.getElementById('enableBtn').disabled = false;
                    
                    // Listen for messages
                    navigator.serviceWorker.addEventListener('message', handleSWMessage);
                    
                    // Load saved state
                    loadSavedState();
                    
                } catch (error) {
                    if (error.message.includes('404') || error.message.includes('not found')) {
                        document.getElementById('setupBox').style.display = 'block';
                        addLog('‚ö†Ô∏è File belum lengkap. Download dan upload file yang diperlukan.');
                    } else {
                        addLog('‚ùå SW Error: ' + error.message);
                    }
                }
            } else {
                addLog('‚ùå Browser tidak support Service Worker');
                showWarning('Browser Anda tidak mendukung PWA');
            }
        }

        // Handle SW messages
        function handleSWMessage(event) {
            console.log('Message from SW:', event.data);
            
            if (event.data.type === 'notification-sent') {
                if (!event.data.isTest) {
                    incrementNotificationCount();
                }
                const msg = event.data.isTest ? 'Test' : `Notifikasi #${notificationCount}`;
                addLog(`üì® ${msg} terkirim`);
                
                // Restart countdown untuk notifikasi berikutnya
                if (isEnabled && !event.data.isTest) {
                    startCountdown();
                }
            } else if (event.data.type === 'schedule-started') {
                addLog('‚úÖ Schedule dimulai di Service Worker');
                addLog(`‚è∞ Interval: ${event.data.interval / 1000} detik`);
            }
        }

        // Install PWA prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
            addLog('üí° PWA siap diinstall!');
        });

        async function installPWA() {
            if (!deferredPrompt) {
                addLog('‚ö†Ô∏è Install prompt tidak tersedia');
                showManualInstallInstructions();
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                addLog('‚úÖ PWA berhasil diinstall!');
                document.getElementById('installPrompt').style.display = 'none';
            } else {
                addLog('‚ùå Install dibatalkan');
            }
            
            deferredPrompt = null;
        }

        function showManualInstallInstructions() {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            if (isIOS) {
                instructions = 'iOS: Tap Share button ‚Üí Add to Home Screen';
            } else if (isAndroid) {
                instructions = 'Android: Menu (‚ãÆ) ‚Üí Install app / Add to Home screen';
            } else {
                instructions = 'Desktop: Klik icon install di address bar';
            }
            
            showWarning(instructions);
        }

        // Enable notifications
        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    const sw = await navigator.serviceWorker.ready;
                    sw.active.postMessage({ type: 'start' });
                    
                    isEnabled = true;
                    localStorage.setItem('notificationEnabled', 'true');
                    updateUIState(true);
                    
                    addLog('‚úÖ Notifikasi diaktifkan (24/7)');
                    addLog('üîî Notifikasi akan muncul setiap 30 DETIK');
                    addLog('‚ö° Mode Testing - Aman untuk tutup app & test');
                    
                    startCountdown();
                } else {
                    showWarning('Permission ditolak. Aktifkan di pengaturan browser.');
                    addLog('‚ùå Permission ditolak');
                }
            } catch (error) {
                addLog('‚ùå Error: ' + error.message);
            }
        }

        // Debug Service Worker
        async function debugServiceWorker() {
            addLog('üêõ Debugging Service Worker...');
            
            if (!swRegistration) {
                addLog('‚ùå Service Worker tidak terdaftar');
                return;
            }
            
            try {
                // Check SW state
                if (swRegistration.active) {
                    addLog('‚úÖ SW State: ACTIVE');
                } else if (swRegistration.installing) {
                    addLog('‚ö†Ô∏è SW State: INSTALLING');
                } else if (swRegistration.waiting) {
                    addLog('‚ö†Ô∏è SW State: WAITING');
                }
                
                // Send message to get status
                const channel = new MessageChannel();
                
                channel.port1.onmessage = (event) => {
                    const status = event.data;
                    addLog('üìä SW Status:');
                    addLog('  - Running: ' + (status.isRunning ? 'YES ‚úÖ' : 'NO ‚ùå'));
                    if (status.nextNotificationTime) {
                        const nextDate = new Date(status.nextNotificationTime);
                        addLog('  - Next: ' + nextDate.toLocaleTimeString());
                    } else {
                        addLog('  - Next: Not scheduled ‚ùå');
                    }
                };
                
                swRegistration.active.postMessage(
                    { type: 'get-status' },
                    [channel.port2]
                );
                
                // Wait a bit then check
                setTimeout(() => {
                    addLog('');
                    addLog('üí° Kalau "Running: NO", coba:');
                    addLog('1. Nonaktifkan notifikasi');
                    addLog('2. Klik "Force Update SW"');
                    addLog('3. Aktifkan notifikasi lagi');
                }, 500);
                
            } catch (error) {
                addLog('‚ùå Error: ' + error.message);
            }
        }

        // Check notification settings
        async function checkNotificationSettings() {
            addLog('üîç Mengecek pengaturan notifikasi...');
            
            // Check permission
            addLog('üìã Permission: ' + Notification.permission);
            
            // Check if notifications are enabled
            if (Notification.permission === 'granted') {
                addLog('‚úÖ Permission: GRANTED');
            } else if (Notification.permission === 'denied') {
                addLog('‚ùå Permission: DENIED - Aktifkan di pengaturan browser/HP');
                showWarning('Notifikasi diblokir! Buka Settings > Apps > Chrome > Notifications');
                return;
            } else {
                addLog('‚ö†Ô∏è Permission: DEFAULT - Belum diminta');
            }
            
            // Check service worker
            if (swRegistration) {
                addLog('‚úÖ Service Worker: Terdaftar');
                
                // Get notifications
                const notifications = await swRegistration.getNotifications();
                addLog('üìä Active notifications: ' + notifications.length);
                
                // Check if SW is active
                if (swRegistration.active) {
                    addLog('‚úÖ Service Worker: ACTIVE');
                } else {
                    addLog('‚ùå Service Worker: NOT ACTIVE');
                }
            } else {
                addLog('‚ùå Service Worker: Tidak terdaftar');
            }
            
            // Device info
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            addLog('üì± Device: ' + (isMobile ? 'Mobile' : 'Desktop'));
            
            // Browser info
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            addLog('üåê Browser: ' + (isChrome ? 'Chrome' : isSafari ? 'Safari' : 'Other'));
            
            addLog('');
            addLog('üí° TIPS:');
            addLog('1. Pastikan notifikasi tidak di-silent/DND mode');
            addLog('2. Android: Settings > Apps > Chrome > Notifications > ON');
            addLog('3. iOS: Settings > Safari > Notifications > Allow');
            addLog('4. Cek apakah ada notifikasi yang muncul di notification center');
        }

        // Force update Service Worker
        async function forceUpdateSW() {
            addLog('üîÑ Memaksa update Service Worker...');
            
            try {
                // Unregister semua SW yang ada
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    addLog('‚úÖ SW lama dihapus');
                }
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Register SW baru
                await initializePWA();
                
                addLog('‚úÖ SW baru terdaftar dengan interval 30 detik');
                addLog('üîÑ Silakan refresh halaman dan aktifkan notifikasi lagi');
                
                // Auto refresh after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                addLog('‚ùå Error: ' + error.message);
            }
        }

        async function sendTestNotification() {
            const sw = await navigator.serviceWorker.ready;
            sw.active.postMessage({ type: 'test' });
            addLog('üß™ Test notifikasi dikirim');
        }

        async function disableNotifications() {
            const sw = await navigator.serviceWorker.ready;
            sw.active.postMessage({ type: 'stop' });
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            isEnabled = false;
            localStorage.setItem('notificationEnabled', 'false');
            updateUIState(false);
            
            document.getElementById('timerDisplay').style.display = 'none';
            addLog('üî¥ Notifikasi dinonaktifkan');
        }

        function startCountdown() {
            document.getElementById('timerDisplay').style.display = 'block';
            
            function updateCountdown() {
                const nextTime = Date.now() + NOTIFICATION_INTERVAL;
                
                if (countdownTimer) clearInterval(countdownTimer);
                
                countdownTimer = setInterval(() => {
                    const remaining = nextTime - Date.now();
                    
                    if (remaining <= 0) {
                        document.getElementById('countdown').textContent = '00:00:00';
                        // Reset countdown untuk notifikasi berikutnya
                        setTimeout(() => {
                            updateCountdown();
                        }, 1000);
                        return;
                    }
                    
                    const h = Math.floor(remaining / 3600000);
                    const m = Math.floor((remaining % 3600000) / 60000);
                    const s = Math.floor((remaining % 60000) / 1000);
                    
                    document.getElementById('countdown').textContent = 
                        `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }, 100); // Update lebih cepat untuk testing
            }
            
            updateCountdown();
        }

        function updateUIState(enabled) {
            document.getElementById('enableBtn').disabled = enabled;
            document.getElementById('testBtn').disabled = !enabled;
            document.getElementById('disableBtn').disabled = !enabled;
            
            const badge = document.getElementById('notifStatus');
            badge.textContent = enabled ? 'Aktif 24/7' : 'Nonaktif';
            badge.className = `status-badge badge-${enabled ? 'success' : 'danger'}`;
        }

        function incrementNotificationCount() {
            notificationCount++;
            localStorage.setItem('notificationCount', notificationCount);
            document.getElementById('notifCount').textContent = notificationCount;
        }

        function loadSavedState() {
            const count = localStorage.getItem('notificationCount');
            if (count) {
                notificationCount = parseInt(count);
                document.getElementById('notifCount').textContent = notificationCount;
            }
            
            const enabled = localStorage.getItem('notificationEnabled');
            if (enabled === 'true' && Notification.permission === 'granted') {
                isEnabled = true;
                updateUIState(true);
                startCountdown();
                addLog('‚úÖ Sesi dilanjutkan dari sebelumnya');
            }
        }

        function showWarning(text) {
            document.getElementById('warningText').textContent = text;
            document.getElementById('warningBox').style.display = 'block';
        }

        function addLog(msg) {
            const container = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = 'log-item';
            const time = new Date().toLocaleTimeString('id-ID');
            item.textContent = `[${time}] ${msg}`;
            
            if (container.firstChild?.textContent === 'Initializing PWA...') {
                container.innerHTML = '';
            }
            
            container.insertBefore(item, container.firstChild);
            while (container.children.length > 12) {
                container.removeChild(container.lastChild);
            }
        }

        // Download files
        function downloadAllFiles() {
            // Download manifest.json
            const manifestBlob = new Blob([JSON.stringify(MANIFEST, null, 2)], { type: 'application/json' });
            downloadFile(manifestBlob, 'manifest.json');
            
            // Download sw.js
            const swBlob = new Blob([SW_CODE], { type: 'application/javascript' });
            downloadFile(swBlob, 'sw.js');
            
            addLog('üì• File manifest.json dan sw.js didownload');
            addLog('üì§ Upload kedua file ke hosting Anda');
            addLog('üîÑ Setelah upload, refresh halaman ini');
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializePWA();
        });

        // Handle app install
        window.addEventListener('appinstalled', () => {
            addLog('üéâ PWA berhasil terinstall!');
            document.getElementById('pwaStatus').textContent = 'Installed';
            document.getElementById('pwaStatus').className = 'status-badge badge-success';
        });
    </script>
</body>
</html>
