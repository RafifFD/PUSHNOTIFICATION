<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            color: #2196F3;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 13px;
            color: #856404;
        }

        .notification-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .log-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .emoji {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .timer-display .time {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
        }

        .device-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="emoji">üîî</span>
        <h1>Push Notification System</h1>
        <p class="subtitle">Notifikasi akan muncul setiap 2 jam sekali</p>

        <div class="device-info" id="deviceInfo">
            <strong>üì± Device:</strong> <span id="deviceType">Detecting...</span><br>
            <strong>üîß Method:</strong> <span id="notificationMethod">Detecting...</span>
        </div>

        <div class="warning-box" id="warningBox" style="display: none;">
            <strong>‚ö†Ô∏è Penting:</strong>
            <span id="warningText"></span>
        </div>

        <div class="timer-display" id="timerDisplay" style="display: none;">
            <div>‚è∞ Notifikasi Berikutnya:</div>
            <div class="time" id="countdown">--:--:--</div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-label">Status Notifikasi:</span>
                <span class="status-badge badge-danger" id="notifStatus">Belum Diaktifkan</span>
            </div>
            <div class="status-item">
                <span class="status-label">System Status:</span>
                <span class="status-badge badge-warning" id="systemStatus">Initializing...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Notifikasi Terkirim:</span>
                <span class="status-value" id="notifCount">0</span>
            </div>
        </div>

        <button class="btn-primary" id="enableBtn" onclick="enableNotifications()" disabled>
            Aktifkan Notifikasi
        </button>
        <button class="btn-secondary" id="testBtn" onclick="sendTestNotification()" disabled>
            Test Notifikasi Sekarang
        </button>
        <button class="btn-danger" id="disableBtn" onclick="disableNotifications()" disabled>
            Nonaktifkan Notifikasi
        </button>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Cara Kerja:</strong>
            1. Klik "Aktifkan Notifikasi" dan izinkan akses<br>
            2. Notifikasi akan muncul setiap 2 jam sekali<br>
            3. <strong id="keepAliveInfo">Sistem akan tetap berjalan</strong><br>
            4. Bekerja di semua device (Mobile & Desktop)
        </div>

        <div class="notification-log">
            <div class="log-title">üìã Log Notifikasi:</div>
            <div id="logContainer">
                <div class="log-item">Menunggu aktivasi...</div>
            </div>
        </div>
    </div>

    <script>
        let notificationCount = 0;
        let notificationTimer = null;
        let countdownTimer = null;
        let nextNotificationTime = null;
        let isEnabled = false;
        let serviceWorkerRegistration = null;
        let usesServiceWorker = false;

        const NOTIFICATION_INTERVAL = 2 * 60 * 60 * 1000; // 2 jam
        // const NOTIFICATION_INTERVAL = 10 * 1000; // 10 detik untuk testing

        // Detect device type
        function detectDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            
            let deviceType = 'Desktop';
            if (isAndroid) deviceType = 'Android';
            else if (isIOS) deviceType = 'iOS';
            else if (isMobile) deviceType = 'Mobile';
            
            document.getElementById('deviceType').textContent = deviceType;
            return { isMobile, isAndroid, isIOS, deviceType };
        }

        // Initialize system berdasarkan device
        async function initializeSystem() {
            const device = detectDevice();
            
            // Check notification support
            if (!('Notification' in window)) {
                document.getElementById('systemStatus').textContent = 'Not Supported';
                document.getElementById('systemStatus').className = 'status-badge badge-danger';
                showWarning('Browser tidak mendukung notifikasi');
                return false;
            }

            // PENTING: Mobile HARUS pakai Service Worker
            // Cek apakah browser mobile yang butuh SW
            const needsServiceWorker = device.isMobile || device.isAndroid || 
                                      (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent));

            if (needsServiceWorker) {
                // Mobile device - WAJIB Service Worker
                if ('serviceWorker' in navigator) {
                    try {
                        await registerServiceWorker();
                        usesServiceWorker = true;
                        document.getElementById('notificationMethod').textContent = 'Service Worker (Mobile Required)';
                        document.getElementById('keepAliveInfo').textContent = 'Notifikasi berjalan walau tab ditutup';
                        addLog('‚úÖ Service Worker aktif (required untuk mobile)');
                    } catch (error) {
                        addLog('‚ùå Service Worker gagal: ' + error.message);
                        document.getElementById('systemStatus').textContent = 'Error';
                        document.getElementById('systemStatus').className = 'status-badge badge-danger';
                        showWarning('Service Worker diperlukan untuk mobile. Pastikan menggunakan HTTPS atau localhost.');
                        return false;
                    }
                } else {
                    document.getElementById('systemStatus').textContent = 'Not Supported';
                    document.getElementById('systemStatus').className = 'status-badge badge-danger';
                    showWarning('Browser mobile Anda tidak mendukung Service Worker');
                    return false;
                }
            } else {
                // Desktop - bisa pakai Direct API
                usesServiceWorker = false;
                document.getElementById('notificationMethod').textContent = 'Direct API (Desktop)';
                document.getElementById('keepAliveInfo').textContent = 'Tab harus tetap terbuka di background';
                addLog('‚úÖ Menggunakan Direct Notification API');
            }

            document.getElementById('systemStatus').textContent = 'Ready';
            document.getElementById('systemStatus').className = 'status-badge badge-success';
            document.getElementById('enableBtn').disabled = false;
            
            loadSavedState();
            return true;
        }

        // Register Service Worker
        async function registerServiceWorker() {
            const swCode = `
// Service Worker
const INTERVAL = 2 * 60 * 60 * 1000;
let intervalId = null;

self.addEventListener('install', (e) => {
    console.log('[SW] Install');
    self.skipWaiting();
});

self.addEventListener('activate', (e) => {
    console.log('[SW] Activate');
    e.waitUntil(clients.claim());
});

async function showNotif(isTest = false) {
    const title = isTest ? 'üß™ Test Notifikasi' : 'üîî Notifikasi Terjadwal';
    const body = isTest ? 'Test berhasil!' : 'Notifikasi otomatis setiap 2 jam';
    
    await self.registration.showNotification(title, {
        body: body,
        icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        vibrate: [200, 100, 200],
        tag: isTest ? 'test' : 'scheduled',
        data: { url: self.location.origin, time: Date.now() }
    });
    
    const clients = await self.clients.matchAll();
    clients.forEach(client => {
        client.postMessage({ type: 'notification-sent', isTest: isTest });
    });
}

function startSchedule() {
    if (intervalId) clearInterval(intervalId);
    showNotif(false);
    intervalId = setInterval(() => showNotif(false), INTERVAL);
}

function stopSchedule() {
    if (intervalId) clearInterval(intervalId);
    self.registration.getNotifications().then(n => n.forEach(x => x.close()));
}

self.addEventListener('message', (e) => {
    if (e.data.type === 'start') startSchedule();
    else if (e.data.type === 'test') showNotif(true);
    else if (e.data.type === 'stop') stopSchedule();
});

self.addEventListener('notificationclick', (e) => {
    e.notification.close();
    e.waitUntil(
        clients.matchAll({ type: 'window' }).then(list => {
            for (let c of list) {
                if ('focus' in c) return c.focus();
            }
            if (clients.openWindow) return clients.openWindow('/');
        })
    );
});
            `;

            try {
                // Unregister existing
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let reg of regs) await reg.unregister();

                // Register new one
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                
                serviceWorkerRegistration = await navigator.serviceWorker.register(url, { scope: './' });
                await navigator.serviceWorker.ready;
                
                // Listen for messages
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'notification-sent') {
                        if (!event.data.isTest) {
                            incrementNotificationCount();
                        }
                        addLog(`üì® ${event.data.isTest ? 'Test' : 'Notifikasi #' + notificationCount} terkirim`);
                    }
                });

                URL.revokeObjectURL(url);
                addLog('‚úÖ Service Worker terdaftar');
                return true;
            } catch (error) {
                console.error('SW Error:', error);
                throw error;
            }
        }

        // Send notification
        async function sendNotification(isTest = false) {
            if (Notification.permission !== 'granted') {
                addLog('‚ùå Permission belum diberikan');
                return;
            }

            try {
                if (usesServiceWorker && serviceWorkerRegistration) {
                    // Pakai Service Worker
                    const sw = await navigator.serviceWorker.ready;
                    sw.active.postMessage({ type: isTest ? 'test' : 'start' });
                } else {
                    // Pakai Direct API - dengan pengecekan
                    const title = isTest ? 'üß™ Test Notifikasi' : 'üîî Notifikasi Terjadwal';
                    const body = isTest ? 'Test berhasil!' : 'Notifikasi otomatis setiap 2 jam';
                    
                    // Cek apakah constructor Notification bisa dipakai
                    try {
                        const notification = new Notification(title, {
                            body: body,
                            icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
                            badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
                            vibrate: [200, 100, 200],
                            tag: isTest ? 'test' : 'scheduled'
                        });

                        notification.onclick = () => {
                            window.focus();
                            notification.close();
                        };

                        setTimeout(() => notification.close(), 10000);

                        if (!isTest) {
                            incrementNotificationCount();
                        }
                        addLog(`üì® ${isTest ? 'Test' : 'Notifikasi #' + notificationCount} terkirim`);
                    } catch (constructorError) {
                        // Jika Notification constructor gagal, coba register SW emergency
                        addLog('‚ö†Ô∏è Direct API gagal, mencoba Service Worker...');
                        await registerServiceWorkerEmergency();
                        usesServiceWorker = true;
                        
                        // Retry dengan SW
                        const sw = await navigator.serviceWorker.ready;
                        sw.active.postMessage({ type: isTest ? 'test' : 'start' });
                    }
                }
            } catch (error) {
                addLog('‚ùå Error: ' + error.message);
                console.error('Notification error:', error);
            }
        }
        
        // Emergency SW registration jika direct API gagal
        async function registerServiceWorkerEmergency() {
            if (serviceWorkerRegistration) return;
            
            try {
                await registerServiceWorker();
                addLog('‚úÖ Service Worker emergency berhasil');
                document.getElementById('notificationMethod').textContent = 'Service Worker (Auto-Switch)';
                document.getElementById('keepAliveInfo').textContent = 'Notifikasi berjalan walau tab ditutup';
            } catch (error) {
                throw new Error('Gagal mengaktifkan notifikasi: ' + error.message);
            }
        }

        // Schedule
        function scheduleNextNotification(delay = NOTIFICATION_INTERVAL) {
            if (notificationTimer) clearTimeout(notificationTimer);

            nextNotificationTime = Date.now() + delay;
            localStorage.setItem('nextNotificationTime', nextNotificationTime);

            notificationTimer = setTimeout(() => {
                sendNotification(false);
                scheduleNextNotification();
            }, delay);

            startCountdown();
            addLog(`‚è∞ Berikutnya: ${new Date(nextNotificationTime).toLocaleTimeString('id-ID')}`);
        }

        // Countdown
        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            document.getElementById('timerDisplay').style.display = 'block';

            countdownTimer = setInterval(() => {
                if (!nextNotificationTime) return;

                const remaining = nextNotificationTime - Date.now();
                if (remaining <= 0) {
                    document.getElementById('countdown').textContent = '00:00:00';
                    return;
                }

                const h = Math.floor(remaining / 3600000);
                const m = Math.floor((remaining % 3600000) / 60000);
                const s = Math.floor((remaining % 60000) / 1000);

                document.getElementById('countdown').textContent = 
                    `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Enable notifications
        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    startNotifications();
                } else {
                    showWarning('Permission ditolak atau dibatalkan');
                    addLog('‚ùå Permission tidak diberikan');
                }
            } catch (error) {
                showWarning('Error: ' + error.message);
                addLog('‚ùå Error: ' + error.message);
            }
        }

        function startNotifications() {
            isEnabled = true;
            localStorage.setItem('notificationEnabled', 'true');
            updateUIState(true);
            
            sendNotification(false);
            
            if (!usesServiceWorker) {
                scheduleNextNotification();
            }
            
            addLog('‚úÖ Notifikasi diaktifkan');
        }

        function sendTestNotification() {
            sendNotification(true);
        }

        function disableNotifications() {
            if (usesServiceWorker && serviceWorkerRegistration) {
                navigator.serviceWorker.ready.then(sw => {
                    sw.active.postMessage({ type: 'stop' });
                });
            }

            if (notificationTimer) clearTimeout(notificationTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            isEnabled = false;
            nextNotificationTime = null;
            localStorage.setItem('notificationEnabled', 'false');
            localStorage.removeItem('nextNotificationTime');
            
            document.getElementById('timerDisplay').style.display = 'none';
            updateUIState(false);
            addLog('üî¥ Notifikasi dinonaktifkan');
        }

        function updateUIState(enabled) {
            document.getElementById('enableBtn').disabled = enabled;
            document.getElementById('testBtn').disabled = !enabled;
            document.getElementById('disableBtn').disabled = !enabled;
            
            const badge = document.getElementById('notifStatus');
            badge.textContent = enabled ? 'Aktif' : 'Nonaktif';
            badge.className = `status-badge badge-${enabled ? 'success' : 'danger'}`;
        }

        function incrementNotificationCount() {
            notificationCount++;
            localStorage.setItem('notificationCount', notificationCount);
            document.getElementById('notifCount').textContent = notificationCount;
        }

        function loadSavedState() {
            const count = localStorage.getItem('notificationCount');
            if (count) {
                notificationCount = parseInt(count);
                document.getElementById('notifCount').textContent = notificationCount;
            }

            const enabled = localStorage.getItem('notificationEnabled');
            if (enabled === 'true' && Notification.permission === 'granted') {
                isEnabled = true;
                updateUIState(true);
                
                if (!usesServiceWorker) {
                    const nextTime = localStorage.getItem('nextNotificationTime');
                    if (nextTime) {
                        nextNotificationTime = parseInt(nextTime);
                        const remaining = nextNotificationTime - Date.now();
                        if (remaining > 0) {
                            scheduleNextNotification(remaining);
                            addLog('‚úÖ Sesi dilanjutkan');
                        } else {
                            startNotifications();
                        }
                    }
                } else {
                    // Restart service worker schedule
                    navigator.serviceWorker.ready.then(sw => {
                        sw.active.postMessage({ type: 'start' });
                        addLog('‚úÖ Service Worker dilanjutkan');
                    });
                }
            }
        }

        function showWarning(text) {
            document.getElementById('warningText').textContent = text;
            document.getElementById('warningBox').style.display = 'block';
        }

        function addLog(msg) {
            const container = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = 'log-item';
            const time = new Date().toLocaleTimeString('id-ID');
            item.textContent = `[${time}] ${msg}`;
            
            if (container.firstChild?.textContent === 'Menunggu aktivasi...') {
                container.innerHTML = '';
            }
            
            container.insertBefore(item, container.firstChild);
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            initializeSystem();
        });
    </script>
</body>
</html>
