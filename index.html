<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            color: #2196F3;
        }

        .notification-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .log-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .emoji {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .setup-section {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .setup-section p {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .step-indicator {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #ffc107;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #856404;
        }

        .step.active {
            background: #ffc107;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="emoji">üîî</span>
        <h1>Push Notification System</h1>
        <p class="subtitle">Notifikasi akan muncul setiap 2 jam sekali</p>

        <div class="setup-section" id="setupSection">
            <h3>üìã Setup Diperlukan</h3>
            <p>Klik tombol di bawah untuk setup Service Worker otomatis</p>
            <button class="btn-success" onclick="autoSetup()">
                üöÄ Auto Setup (1 Klik)
            </button>
            <div class="step-indicator">
                <div class="step" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-label">Status Notifikasi:</span>
                <span class="status-badge badge-danger" id="notifStatus">Belum Diaktifkan</span>
            </div>
            <div class="status-item">
                <span class="status-label">Service Worker:</span>
                <span class="status-badge badge-warning" id="swStatus">Waiting...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Notifikasi Terkirim:</span>
                <span class="status-value" id="notifCount">0</span>
            </div>
        </div>

        <button class="btn-primary" id="enableBtn" onclick="enableNotifications()" disabled>
            Aktifkan Notifikasi
        </button>
        <button class="btn-secondary" id="testBtn" onclick="sendTestNotification()" disabled>
            Test Notifikasi Sekarang
        </button>
        <button class="btn-danger" id="disableBtn" onclick="disableNotifications()" disabled>
            Nonaktifkan Notifikasi
        </button>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Cara Kerja:</strong>
            1. Klik "Auto Setup" untuk install Service Worker<br>
            2. Klik "Aktifkan Notifikasi" dan izinkan akses<br>
            3. Notifikasi akan muncul setiap 2 jam sekali<br>
            4. Notifikasi tetap berjalan walau tab/browser ditutup<br>
            5. Bekerja di Android, iOS (Safari 16.4+), Desktop
        </div>

        <div class="notification-log">
            <div class="log-title">üìã Log Notifikasi:</div>
            <div id="logContainer">
                <div class="log-item">Menunggu setup...</div>
            </div>
        </div>
    </div>

    <script>
        let notificationCount = 0;
        let notificationTimer = null;

        // Service Worker Code
        const SERVICE_WORKER_CODE = `
// Service Worker untuk Push Notification
const NOTIFICATION_INTERVAL = 2 * 60 * 60 * 1000; // 2 jam
let intervalId = null;

self.addEventListener('install', (event) => {
    console.log('[SW] Installing...');
    self.skipWaiting();
});

self.addEventListener('activate', (event) => {
    console.log('[SW] Activated');
    event.waitUntil(clients.claim());
});

async function sendNotification() {
    const options = {
        body: 'Ini notifikasi otomatis setiap 2 jam. Klik untuk buka aplikasi.',
        icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
        vibrate: [200, 100, 200],
        tag: 'scheduled-notification',
        requireInteraction: false,
        data: {
            timestamp: Date.now(),
            url: self.location.origin
        }
    };

    try {
        await self.registration.showNotification('üîî Notifikasi Terjadwal', options);
        
        const allClients = await clients.matchAll();
        allClients.forEach(client => {
            client.postMessage({
                type: 'notification-sent',
                timestamp: Date.now()
            });
        });
        
        console.log('[SW] Notification sent:', new Date().toLocaleString());
    } catch (error) {
        console.error('[SW] Error:', error);
    }
}

function startSchedule() {
    if (intervalId) clearInterval(intervalId);
    sendNotification(); // Kirim pertama kali
    intervalId = setInterval(() => {
        sendNotification();
    }, NOTIFICATION_INTERVAL);
    console.log('[SW] Schedule started');
}

function stopSchedule() {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
    self.registration.getNotifications().then(notifications => {
        notifications.forEach(notification => notification.close());
    });
    console.log('[SW] Schedule stopped');
}

self.addEventListener('message', (event) => {
    console.log('[SW] Message received:', event.data.type);
    
    if (event.data.type === 'start-notifications') {
        startSchedule();
    } else if (event.data.type === 'test-notification') {
        sendNotification();
    } else if (event.data.type === 'stop-notifications') {
        stopSchedule();
    }
});

self.addEventListener('notificationclick', (event) => {
    event.notification.close();
    event.waitUntil(
        clients.matchAll({ type: 'window' }).then((clientList) => {
            for (let client of clientList) {
                if ('focus' in client) return client.focus();
            }
            if (clients.openWindow) return clients.openWindow('/');
        })
    );
});
`;

        async function autoSetup() {
            updateStep(1, true);
            addLog('üîÑ Memulai auto setup...');

            try {
                // Step 1: Cek support
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Browser tidak mendukung Service Worker');
                }

                updateStep(1, true);
                addLog('‚úÖ Browser mendukung Service Worker');

                // Step 2: Buat dan register Service Worker menggunakan data URL
                updateStep(2, true);
                addLog('üîÑ Membuat Service Worker...');

                // Buat base64 encoded data URL
                const swBlob = new Blob([SERVICE_WORKER_CODE], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                try {
                    // Unregister semua SW yang ada
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }

                    // Register SW baru dengan scope yang tepat
                    const registration = await navigator.serviceWorker.register(swUrl, {
                        scope: './'
                    });

                    await navigator.serviceWorker.ready;
                    
                    updateStep(2, true);
                    addLog('‚úÖ Service Worker berhasil terdaftar');

                    // Step 3: Setup listener
                    updateStep(3, true);
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data.type === 'notification-sent') {
                            incrementNotificationCount();
                        }
                    });

                    addLog('‚úÖ Setup selesai! Silakan aktifkan notifikasi.');
                    
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('swStatus').textContent = 'Ready';
                    document.getElementById('swStatus').className = 'status-badge badge-success';
                    document.getElementById('enableBtn').disabled = false;

                    // Cek permission
                    if (Notification.permission === 'granted') {
                        updateUIState(true);
                        loadNotificationCount();
                    }

                } catch (error) {
                    // Jika gagal dengan blob URL, coba metode alternatif
                    addLog('‚ö†Ô∏è Mencoba metode alternatif...');
                    await setupWithInlineWorker();
                }

            } catch (error) {
                console.error('Setup error:', error);
                addLog('‚ùå Error: ' + error.message);
                document.getElementById('swStatus').textContent = 'Error';
                document.getElementById('swStatus').className = 'status-badge badge-danger';
            }
        }

        async function setupWithInlineWorker() {
            // Metode alternatif: gunakan inline worker dengan navigator.serviceWorker API
            const base64SW = btoa(unescape(encodeURIComponent(SERVICE_WORKER_CODE)));
            const dataUrl = `data:application/javascript;base64,${base64SW}`;
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }

                const registration = await navigator.serviceWorker.register(dataUrl, {
                    scope: './'
                });

                await navigator.serviceWorker.ready;

                updateStep(3, true);
                addLog('‚úÖ Setup berhasil dengan metode alternatif!');
                
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('swStatus').textContent = 'Ready';
                document.getElementById('swStatus').className = 'status-badge badge-success';
                document.getElementById('enableBtn').disabled = false;

                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'notification-sent') {
                        incrementNotificationCount();
                    }
                });

                if (Notification.permission === 'granted') {
                    updateUIState(true);
                    loadNotificationCount();
                }

            } catch (error) {
                throw new Error('Semua metode setup gagal. Pastikan menggunakan HTTPS atau localhost.');
            }
        }

        function updateStep(stepNum, active) {
            const step = document.getElementById(`step${stepNum}`);
            if (active) step.classList.add('active');
        }

        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    const registration = await navigator.serviceWorker.ready;
                    registration.active.postMessage({ type: 'start-notifications' });
                    
                    updateUIState(true);
                    addLog('‚úÖ Notifikasi berhasil diaktifkan');
                    addLog('‚è∞ Notifikasi akan muncul setiap 2 jam');
                    
                } else if (permission === 'denied') {
                    alert('‚ùå Permission ditolak. Aktifkan di pengaturan browser.');
                } else {
                    alert('‚ö†Ô∏è Permission dibatalkan.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function sendTestNotification() {
            try {
                const registration = await navigator.serviceWorker.ready;
                registration.active.postMessage({ type: 'test-notification' });
                addLog('üß™ Test notifikasi dikirim');
            } catch (error) {
                addLog('‚ùå Error test: ' + error.message);
            }
        }

        async function disableNotifications() {
            try {
                const registration = await navigator.serviceWorker.ready;
                registration.active.postMessage({ type: 'stop-notifications' });
                updateUIState(false);
                addLog('üî¥ Notifikasi dinonaktifkan');
            } catch (error) {
                addLog('‚ùå Error disable: ' + error.message);
            }
        }

        function updateUIState(enabled) {
            document.getElementById('enableBtn').disabled = enabled;
            document.getElementById('testBtn').disabled = !enabled;
            document.getElementById('disableBtn').disabled = !enabled;
            
            const statusBadge = document.getElementById('notifStatus');
            if (enabled) {
                statusBadge.textContent = 'Aktif';
                statusBadge.className = 'status-badge badge-success';
            } else {
                statusBadge.textContent = 'Nonaktif';
                statusBadge.className = 'status-badge badge-danger';
            }
        }

        function incrementNotificationCount() {
            notificationCount++;
            localStorage.setItem('notificationCount', notificationCount);
            document.getElementById('notifCount').textContent = notificationCount;
            addLog(`üì® Notifikasi #${notificationCount} - ${new Date().toLocaleTimeString('id-ID')}`);
        }

        function loadNotificationCount() {
            const saved = localStorage.getItem('notificationCount');
            if (saved) {
                notificationCount = parseInt(saved);
                document.getElementById('notifCount').textContent = notificationCount;
            }
        }

        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.textContent = message;
            
            if (logContainer.firstChild && logContainer.firstChild.textContent === 'Menunggu setup...') {
                logContainer.innerHTML = '';
            }
            
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Auto check on load
        window.addEventListener('load', async () => {
            loadNotificationCount();
            
            // Cek apakah sudah ada SW terdaftar
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('swStatus').textContent = 'Ready';
                    document.getElementById('swStatus').className = 'status-badge badge-success';
                    document.getElementById('enableBtn').disabled = false;
                    addLog('‚úÖ Service Worker sudah terdaftar');

                    if (Notification.permission === 'granted') {
                        updateUIState(true);
                    }
                }
            }
        });
    </script>
</body>
</html>
